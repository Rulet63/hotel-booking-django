name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Create .env file
      run: |
        cat > .env << 'EOF'
        SECRET_KEY=django-insecure-your-actual-secret-key-change-this
        DEBUG=True
        ALLOWED_HOSTS=localhost,127.0.0.1,web

        POSTGRES_DB=hotel_db
        POSTGRES_USER=postgres
        POSTGRES_PASSWORD=postgres
        POSTGRES_HOST=db
        POSTGRES_PORT=5432

        LOG_LEVEL=INFO
        EOF

    - name: Set up Docker Compose
      run: |
        docker compose up -d
        sleep 15   # нужно больше, иначе БД не успеет подняться
    
    - name: Run migrations
      run: docker compose exec web python manage.py migrate
    
    - name: Run tests
      run: docker compose exec web python -m pytest /app/tests/ -v
